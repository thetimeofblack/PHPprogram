<!DOCTYPE html>
<html lang="en">

<head> 
    <meta charset="UTF-8">
    <title>Score Editor</title>
    <!-- midi.js css -->
    <link href="./examples/css/MIDIPlayer.css" rel="stylesheet" type="text/css" />
    <!-- shim -->
    <script src="./inc/shim/Base64.js" type="text/javascript"></script>
    <script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="./inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="./inc/jasmid/stream.js"></script>
    <script src="./inc/jasmid/midifile.js"></script>
    <script src="./inc/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="./js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="./js/midi/gm.js" type="text/javascript"></script>
    <script src="./js/midi/loader.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="./js/midi/player.js" type="text/javascript"></script>
    <script src="./js/midi/synesthesia.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="./js/util/dom_request_script.js" type="text/javascript"></script>
    <!-- includes -->
    <script src="./examples/inc/timer.js" type="text/javascript"></script>
    <script src="./examples/inc/colorspace.js" type="text/javascript"></script>
    <script src="./examples/inc/event.js" type="text/javascript"></script>
    <!-- midi Convert -->
    <script src="midiConvert.js" type="text/javascript"></script>
    <script>
        var Str = "4d 54 68 64 00 00 00 06 00 02 00 03 00 78 4d 54 72 6b 00 00 00 17 00 ff 03 00 00 ff 51 03 07 a1 20 00 ff 58 04 04 02 18 08 00 ff 2f 00 ";
        var melHead = "4d 54 72 6b ";
        var choHead = "4d 54 72 6b ";
        var melStr = "00 ff 03 00 "; 
        var choStr = "00 ff 03 00 ";
        var endStr = "00 ff 2f 00 ";
        var contentLoaded = false;
        // /**
        //  * convert hex string into binary
        //  * @param content
        //  * @returns {string}
        //  */
        // var getBinContent = function(content)
        // {
        //     var midiBin = content.split(' ');
        //     var text = "";
        //     for(var i = 0; i<midiBin.length; i++)
        //     {
        //
        //         var temp = "0x" + midiBin[i];
        //         text += String.fromCharCode(temp);
        //     }
        //     return text;
        // }
        //
        // /**
        //  * load the content to midi player
        //  * @param content
        //  */
        // var loadMidiContent = function(content)
        // {
        //     MIDI.loader = new sketch.ui.Timer;
        //     MIDI.loadPlugin({
        //         soundfontUrl: "./soundfont/",
        //         onprogress: function (state, progress) {
        //             MIDI.loader.setValue(progress * 100);
        //         }
        //     })
        //     var midiContent = getBinContent(content);
        //     player = MIDI.Player;
        //     player.currentData = midiContent;
        // }
        //
        // /**
        //  * control the midi player whether to play or resume
        //  */
        // var play = function ()
        // {
        //     if(!player.playing)
        //     {
        //         player.loadMidiFile(player.start());
        //     }
        //     else
        //     {
        //         player.resume();
        //     }
        //     // document.getElementById("playButton").innerHTML = "click to play";
        //     // alert(player.playing);
        // }
        //
        // /**
        //  * control the midi player to pause
        //  */
        // var pause = function()
        // {
        //     player.pause(true);
        //     // document.getElementById("playButton").innerHTML = "click to resume";
        // }
        //
        // /**
        //  * control the midi player to stop
        //  */
        // var stop = function()
        // {
        //     player.stop();
        //     document.getElementById("playButton").innerHTML = "click to play";
        // }
        //
        // /**
        //  * assemble the content
        //  */
        // var loadAndPlay = function()
        // {
        //     var melLength = (melStr + endStr).length / 3;
        //     melLength = formatLength(melLength);
        //     var choLength = (choStr + endStr).length / 3;
        //     choLength = formatLength(choLength);
        //     var content = Str + melHead + melLength + melStr + endStr + choHead + choLength + choStr + endStr;
        //     loadMidiContent(content);
        //     contentLoaded = true;
        // }
        //
        // /**
        //  * format the byte length of melody and chords
        //  * @param length
        //  * @returns {*}
        //  */
        // var formatLength = function(length)
        // {
        //     leng1 = length & parseInt("0xff000000");
        //     leng1 = leng1 >> 24;
        //     leng2 = length & parseInt("0x00ff0000");
        //     leng2 = leng2 >> 16;
        //     leng3 = length & parseInt("0x0000ff00");
        //     leng3 = leng3 >> 8;
        //     leng4 = length & parseInt("0x000000ff");
        //     length = leng1.toString(16) + " " + leng2.toString(16) + " " + leng3.toString(16) + " " + leng4.toString(16) + " ";
        //     return length;
        // }

        function changeTabNote(){
            if (document.getElementById("melody").style.display == "none"){
                document.getElementById("melody").style.display = "block";
                document.getElementById("chord").style.display = "none";
            }
        }

        function changeTabChord(){    
            if (document.getElementById("chord").style.display == "none"){
                document.getElementById("chord").style.display = "block";
                document.getElementById("melody").style.display = "none";
            }
        }

        function addNote(noteName,blockColor){
            var noteNumber;                
            var noteTime;

            if((document.getElementById("noteLength").value>=1)&&(document.getElementById("noteLength").value<=8)&&(document.getElementById("noteGroup").value!="")){
                var tr1 = document.getElementById("melrow1");
                var td1 = tr1.insertCell();
                //td1.setAttribute ("className","tick");
                td1.colSpan = document.getElementById("noteLength").value;
                td1.innerHTML = document.getElementById("noteLength").value;
                //alert(tr1.cells.length);
                var tr2 = document.getElementById("melrow2");
                for (i=0;i<document.getElementById("noteLength").value;i++){
                    var td2 = tr2.insertCell();
                    //td2.style.width="200px";
                    //td2.style.minwidth="200px";
                    td2.setAttribute("width","50px");
                    td2.style.backgroundColor = blockColor;
                }
         
                //alert(tr2.cells.length);

                var tr3 = document.getElementById("melrow3");
                var td3 = tr3.insertCell();
                //td3.setAttribute ("className","tick");
                td3.colSpan = document.getElementById("noteLength").value;
                td3.innerHTML = noteName + document.getElementById("noteGroup").value;
        
                var tr4 = document.getElementById("melrow4");
                var td4 = tr4.insertCell();
                //td4.setAttribute ("className","tick");
                td4.colSpan = document.getElementById("noteLength").value;
                //alert(unitCount);
                //alert(td4.parentNode.cells.length - 1);
                td4.innerHTML = "<button onclick='deleteNote(this)'>delete</button>";
                //alert(td4.colomn.count);
                //unitCount += parseInt(document.getElementById("noteLength").value);
                
                
        //generate string to be played
            switch (noteName){
                case "C":
                    noteNumber = 0;
                    break;
                case "C#":
                    noteNumber = 1;
                    break;
                case "D":
                    noteNumber = 2;
                    break;
                case "D#":
                    noteNumber = 3;
                    break;
                case "E":
                    noteNumber = 4;
                    break;
                case "F":
                    noteNumber = 5;
                    break;
                case "F#":
                    noteNumber = 6;
                    break;
                case "G":
                    noteNumber = 7;
                    break;
                case "G#":
                    noteNumber = 8;
                    break;
                case "A":
                    noteNumber = 9;
                    break;
                case "A#":
                    noteNumber = 10;
                    break;
                case "B":
                    noteNumber = 11;
                    break;
            }
            
            switch (document.getElementById("noteGroup").value){
                case "-2":
                    noteNumber += 0;
                    break;
                case "-1":
                    noteNumber += 12;
                    break;
                case "0":
                    noteNumber += 24;
                    break;
                case "1":
                    noteNumber += 36;
                    break;
                case "2":
                    noteNumber += 48;
                    break;
                case "3":
                    noteNumber += 60;
                    break;
                case "4":
                    noteNumber += 72;
                    break;
                case "5":
                    noteNumber += 84;
                    break;
                case "6":
                    noteNumber += 96;
                    break;
                case "7":
                    noteNumber += 108;
                    break;
            }
            //alert(noteNumber);
            //alert(noteNumber.toString(16));
            
            //transform to HEX
            melStr = melStr + "00 90 " + noteNumber.toString(16) + " ";
            
            //add velocity
            melStr = melStr + "64 ";

            //add time length
            noteTime = parseInt(document.getElementById("noteLength").value) * 60;
            //alert(noteTime);
            switch (noteTime){
                case 60:
                    melStr = melStr + noteTime.toString(16) + " ";
                    break;
                case 120:
                    melStr = melStr + noteTime.toString(16) + " ";
                    break;
                case 180:
                    melStr = melStr + "81 34 ";
                    break;
                case 240:
                    melStr = melStr + "81 70 ";
                    break;
                case 300:
                    melStr = melStr + "82 2C ";
                    break;
                case 360:
                    melStr = melStr + "82 68 ";
                    break;
                case 420:
                    melStr = melStr + "83 24 ";
                    break;
                case 480:
                    melStr = melStr + "83 60 ";
                    break;   
            }
        
        //release
        melStr = melStr + "80 " + noteNumber.toString(16) + " " + "64 ";
        //alert(melStr);
        }
    } 


        function addChord(chordName,blockColor){
            var chordNumber;
            var chordTime;

            if((document.getElementById("chordLength").value>=1)&&(document.getElementById("chordLength").value<="8")&&(document.getElementById("chordGroup").value!="")){
                var tr5 = document.getElementById("chorow1");
                var td5 = tr5.insertCell();
                //td5.setAttribute ("className","tick");
                td5.colSpan = document.getElementById("chordLength").value;
                td5.innerHTML = document.getElementById("chordLength").value;
                
                var tr6 = document.getElementById("chorow2");
                for (i=0;i<document.getElementById("chordLength").value;i++){
                    var td6 = tr6.insertCell();
                    //td6.style.width="200px";
                    //td6.style.minwidth="200px";
                    td6.setAttribute("width","50px");
                    td6.style.backgroundColor = blockColor;
                }
                
                var tr7 = document.getElementById("chorow3");
                var td7 = tr7.insertCell();
                td7.colSpan = document.getElementById("chordLength").value;
                //alert(document.getElementById("color").value);
                if (document.getElementById("color").value == "major"){
                    td7.innerHTML = chordName + document.getElementById("chordGroup").value;
                }else if(document.getElementById("color").value == "minor"){
                    td7.innerHTML = chordName + document.getElementById("chordGroup").value + "m";
                }

                var tr8 = document.getElementById("chorow4");
                var td8 = tr8.insertCell();
                //td8.setAttribute ("className","tick");
                td8.colSpan = document.getElementById("chordLength").value;
                td8.innerHTML = "<button onclick='deleteChord(this)'>delete</button>";  

                  //generate string to be played
                switch (chordName){
                    case "C":
                        chordNumber = 0;
                        break;
                    case "C#":
                        chordNumber = 1;
                        break;
                    case "D":
                        chordNumber = 2;
                        break;
                    case "D#":
                        chordNumber = 3;
                        break;
                    case "E":
                        chordNumber = 4;
                        break;
                    case "F":
                        chordNumber = 5;
                        break;
                    case "F#":
                        chordNumber = 6;
                        break;
                    case "G":
                        chordNumber = 7;
                        break;
                    case "G#":
                        chordNumber = 8;
                        break;
                    case "A":
                        chordNumber = 9;
                        break;
                    case "A#":
                        chordNumber = 10;
                        break;
                    case "B":
                        chordNumber = 11;
                        break;
                }
                
                switch (document.getElementById("chordGroup").value){
                    case "-2":
                        chordNumber += 0;
                        break;
                    case "-1":
                        chordNumber += 12;
                        break;
                    case "0":
                        chordNumber += 24;
                        break;
                    case "1":
                        chordNumber += 36;
                        break;
                    case "2":
                        chordNumber += 48;
                        break;
                    case "3":
                        chordNumber += 60;
                        break;
                    case "4":
                        chordNumber += 72;
                        break;
                    case "5":
                        chordNumber += 84;
                        break;
                    case "6":
                        chordNumber += 96;
                        break;
                    case "7":
                        chordNumber += 108;
                        break;
                }

                //transform to HEX
                if (document.getElementById("color").value == "major"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }else if (document.getElementById("color").value == "minor"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }
                
                //add time
                chordTime = parseInt(document.getElementById("chordLength").value) * 60;
                //alert(chordTime);
                switch (chordTime){
                    case 60:
                        choStr = choStr + chordTime.toString(16) + " ";
                        break;
                    case 120:
                        choStr = choStr + chordTime.toString(16) + " ";
                        break;
                    case 180:
                        choStr = choStr + "81 34 ";
                        break;
                    case 240:
                        choStr = choStr + "81 70 ";
                        break;
                    case 300:
                        choStr = choStr + "82 2C ";
                        break;
                    case 360:
                        choStr = choStr + "82 68 ";
                        break;
                    case 420:
                        choStr = choStr + "83 24 ";
                        break;
                    case 480:
                        choStr = choStr + "83 60 ";
                        break;   
                }

                //release
                if (document.getElementById("color").value == "major"){
                    choStr = choStr + "80 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }else if (document.getElementById("color").value == "minor"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }

                //alert(choStr);

            }
            
        }

        function deleteNote(o){
            //remove code
            if (parseInt(document.getElementById("melodyTable").rows[1].cells[o.parentNode.cellIndex].innerHTML)<3){
                melStr = melStr.substr(0,melStr.length-24);
            }else{
                melStr = melStr.substr(0,melStr.length-27);
            }

            var startCellIndex = 1;
            for(i=1;i<o.parentNode.cellIndex;i++){
                startCellIndex = startCellIndex + parseInt(document.getElementById("melodyTable").rows[1].cells[i].innerHTML); 
            }
            var singleIndex = parseInt(o.parentNode.cellIndex);
            var duration = parseInt(document.getElementById("melodyTable").rows[1].cells[o.parentNode.cellIndex].innerHTML);
            
            //delete single cell
            document.getElementById("melrow1").deleteCell(o.parentNode.cellIndex);
            document.getElementById("melrow3").deleteCell(o.parentNode.cellIndex);
            document.getElementById("melrow4").deleteCell(o.parentNode.cellIndex);

            //delete block
            for(i=0;i<duration;i++){
                document.getElementById("melrow2").deleteCell(startCellIndex);
            }
        }

        function deleteChord(o){
            //remove code
            if (parseInt(document.getElementById("chordTable").rows[1].cells[o.parentNode.cellIndex].innerHTML)<3){
                choStr = choStr.substr(0,choStr.length-60);
            }else{
                choStr = choStr.substr(0,choStr.length-63);
            }

            var startCellIndex = 1;
            for(i=1;i<o.parentNode.cellIndex;i++){
                startCellIndex = startCellIndex + parseInt(document.getElementById("chordTable").rows[1].cells[i].innerHTML); 
            }
            var singleIndex = parseInt(o.parentNode.cellIndex);
            var duration = parseInt(document.getElementById("chordTable").rows[1].cells[o.parentNode.cellIndex].innerHTML);
            
            //delete single cell
            document.getElementById("chorow1").deleteCell(o.parentNode.cellIndex);
            document.getElementById("chorow3").deleteCell(o.parentNode.cellIndex);
            document.getElementById("chorow4").deleteCell(o.parentNode.cellIndex);

            //delete block
            for(i=0;i<duration;i++){
                document.getElementById("chorow2").deleteCell(startCellIndex);
            }  
        }
        
    </script>


    <style>
        body{
            background-color:rgba(0,128,255,0.2);
        }

        footer{
			color:black;
			font-family:Bahnschrift;
			font-size:20px;
			text-align:center;
			padding-top:150px;
		}

        #hint{
            color:black;
			font-family:Bahnschrift;
			font-size:18px;
        }
    </style>
</head>

<body>
    <!-- login interface -->

    <header>
    </header>


    <!-- title -->
    <h1 style="font-size:50px;font-family:Arial Black;color:orange;text-align:center;">Build your own score!</h1>


    <table border="1" style="table-layout:fixed;width:1880px;" align="center">
        <tr>
            <!-- note choosing pad -->
            <td style="width:400px;background-color:#fffbf0;">
                <!-- choosing window -->
                <div style="text-align:center;">
                    <div align="center">
                        <button style="width:140px;height:70px;font-size:20px;font-family:Arial Black;font-weight:bold;color:black;background-color:white;" onclick="changeTabNote()">Melody</button>
                        <button style="width:140px;height:70px;font-size:20px;font-family:Arial Black;font-weight:bold;color:black;background-color:white;" onclick="changeTabChord()">Chord</button>
                    </div>
                    <br><br>
                    <!-- note pad -->
                    <section id="melody" name="melody" style="text-align:center;display:block;">
                        <table align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr>
                                <td> 
                                    <button onclick="addNote('C','#3eede7')">C</button><br>
                                    <button onclick="addNote('C#','#4b5cc4')">C#</button><br>
                                    <button onclick="addNote('D','#8d4bbb')">D</button><br>
                                    <button onclick="addNote('D#','#ff4777')">D#</button><br>
                                    <button onclick="addNote('E','#ca6924')">E</button><br>
                                    <button onclick="addNote('F','#eacd76')">F</button><br>
                                    <button onclick="addNote('F#','#d6c6af')">F#</button><br>
                                    <button onclick="addNote('G','#3de1ad')">G</button><br>
                                    <button onclick="addNote('G#','#70f3ff')">G#</button><br>
                                    <button onclick="addNote('A','#f20c00')">A</button><br>
                                    <button onclick="addNote('A#','#ffa400')">A#</button><br>
                                    <button onclick="addNote('B','#fff143')">B</button><br>
                                </td>
                                <td>
                                    <p id="hint">please select the note group</p>
                                    <select id="noteGroup" name="noteGroup">
                                        <option value="">---</option>
                                        <option value="-2">-2</option>
                                        <option value="-1">-1</option>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                    </select>
                                    <p id="hint">please select the length</p>
                                    <input type="text" size="1" maxlength="1" id="noteLength" name="noteLength"/>
                                </td>
                            </tr>
                        </table>
                        
                    </section>
					
                    <!-- chord pad -->
                    <section id="chord" name="chord" style="display:none">
                        <table align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr>
                                <td>
                                    <button onclick="addChord('C','#3eede7')">C</button><br>
                                    <button onclick="addChord('C#','#4b5cc4')">C#</button><br>
                                    <button onclick="addChord('D','#8d4bbb')">D</button><br>
                                    <button onclick="addChord('D#','#ff4777')">D#</button><br>
                                    <button onclick="addChord('E','#ca6924')">E</button><br>
                                    <button onclick="addChord('F','#eacd76')">F</button><br>
                                    <button onclick="addChord('F#','#d6c6af')">F#</button><br>
                                    <button onclick="addChord('G','#3de1ad')">G</button><br>
                                    <button onclick="addChord('G#','#70f3ff')">G#</button><br>
                                    <button onclick="addChord('A','#f20c00')">A</button><br>
                                    <button onclick="addChord('A#','#ffa400')">A#</button><br>
                                    <button onclick="addChord('B','#fff143')">B</button><br>
                                </td>
                                <td>
                                    <p id="hint">Please select the chord color</p>
                                    <select id="color" name="color">
                                        <option value="major">Major</option>
                                        <option value="minor">Minor</option>
                                    </select>
                                    <br><br>
                                    <p id="hint">Please select the chord group</p>
                                    <select id="chordGroup" name="chordGroup">
                                        <option value="">---</option>
                                        <option value="-2">-2</option>
                                        <option value="-1">-1</option>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                    </select>
									<p id="hint">please select the length</p>
                                    <input type="text" size="1" maxlength="1" id="chordLength" name="chordLength"/>
                                </td>
                            </tr>
                        </table>
                        
                    </section>
                </div>
            </td>
            <!-- display window -->
            <td style="width:1070px;background-color:#fffbf0;">
                <span id="hint">Name: </span><input type="text" id="MelodyNameText" />&nbsp;&nbsp;&nbsp;
                <span id="hint">Description: </span><input type="text" id="MelodyDescriptionText"/>
                <br><br>
                <div style="border:solid white 1px;overflow-x:scroll;width:1070px;">
                    <!-- melody display -->
                    <table cellpadding="0" cellspacing="0" id="melodyTable" border="1" table-layout="fixed" style="max-width:1070px;border:solid white 1px;">
                        <th>Melody</th>
                        <tr id="melrow1" height="20px;">
                            <td>Note Length</td>
                        </tr>
                        <tr id="melrow2" height="20px;">
                            <td>Note Block</td>
                        </tr>
                        <tr id="melrow3" height="20px;">
                            <td>Note Name</td>
                        </tr>
                        <tr id="melrow4" height="20px;">
                            <td>&nbsp;&nbsp;&nbsp;</td>
                        </tr>
                    </table>
                </div>
                <br><br>
                <div style="border:solid white 1px;overflow-x:scroll;width:1070px;">
                    <!-- chord display -->
                    <table cellpadding="0" cellspacing="0" id="chordTable" border="1" table-layout="fixed" style="max-width:1070px;border:solid white 1px;">
                        <th>Chord</th>
                        <tr id="chorow1" height="20px;">
                            <td>Chord Length</td>
                        </tr>
                        <tr id="chorow2" height="20px;">
                            <td>Chord Block</td>
                        </tr>
                        <tr id="chorow3" height="20px;">
                            <td>Chord Name</td>
                        </tr>
                        <tr id="chorow4" height="20px;">
                            <td>&nbsp;&nbsp;&nbsp;</td>
                        </tr>
                    </table>
                </div>
                <br><br>
                <div>
                    <button name="play" onclick="play()">play</button>
                    <button name="pause" onclick="pause()">pause</button>
                    <button name="stop" onclick="stop()">stop</button>
                    <button name="load" onclick="loadAndPlay()">load</button>
                    <form action="save.php" method="POST" onsubmit="sendData(this);return false;">
                        <input id="scorename" name ="scorename" type="text"  style="display: none;"/>
                        <input id="scoredescription" name ="scoredescription" type="text"  style="display: none;"/>
                        <input id="melodyname" name ="melodyname" type="text"  style="display: none;"/>
                        <input id="melodydescription" name ="melodydescription" type="text"  style="display: none;"/>
                        <input id="lengthlist" name ="lengthlist"  type="text"   style= "display: none;"/>
                        <input id="chordlist"  name ="chordlist"   type="text"   style= "display: none;"/>
                        <input id="timelist"   name ="timelist"    type="text"   style= "display: none;"/>
                        <input id="notelist"   name ="notelist"    type="text"   style= "display: none;"/>
                        <input id="userid"     name = "userid"     type ="text"  style ="display:none;"/>
                        <input name="save" value="save" type="submit" style="margin-left:20%;"/>
                    </form>

                </div>
            </td>
            <td style="width:400px;background-color:#fffbf0;">
                <div style="text-align:center;">
                    <section  id="userInfo" name="userInfo" style="text-align:center;display:block;">
                        <!-- display user information get from db -->
                        Username: <label id="userName"></label><br><br><br>
                        <table id="userTable" align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr id="userScoreList">
                                <th>Score Name</th>
                            </tr>
                        </table>
                    </section>
                </div>
            </td>
        </tr>
    </table>

    <footer>
		<p>CopyrightÂ® 2019 He,Yining Zhou,Kaiwen and Shan,Jiaxiang</p>
	</footer>


    <script>
        var notelist = new Array();
        var nlengthlist = new Array() ;
        var name;
        var chordlist;
        var clengthlist;

        function sendData(o) {
            var notelist   =  new Array();
            var lengthlist =  new Array();
            var timelist=   new Array();
            var chordlist=  new Array();



            var melodytdlist1 = document.getElementById("melrow1").childNodes;
            var melodytdlist3 = document.getElementById("melrow3").childNodes;
            var scoretdlist1  = document.getElementById("chorow1").childNodes;
            var scoretdlist3  = document.getElementById("chorow3").childNodes;



            for(i = 3 ; i< melodytdlist3.length ; i++){
                var element = melodytdlist3[i];
                chordlist[i-3] =  element.innerHTML ;
            }


            for(i = 3 ; i< melodytdlist1.length ; i++){
                var element = melodytdlist1[i];
                lengthlist[i-3] = element.innerHTML;
            }


            for(i = 3 ; i< scoretdlist3.length ; i++){
                var element = scoretdlist3[i];
                notelist[i-3] = element.innerHTML;

            }

            for(i=3 ;i<scoretdlist1.length ; i++){
                var element = scoretdlist1[i];
                timelist[i-3] = element.innerHTML;

            }

            var chordjson =  JSON.stringify(chordlist) ;
            var lengthjson = JSON.stringify(lengthlist);
            var notejson =   JSON.stringify(notelist)  ;
            var timejson =   JSON.stringify(timelist)  ;

            var lengthlistinput = document.getElementById("lengthlist");
            lengthlistinput.value = lengthjson ;
            var chordlistinput = document.getElementById("chordlist");
            chordlistinput.value = chordjson ;
            var timelistinput = document.getElementById("timelist");
            timelistinput.value = timejson ;
            var notelistinput = document.getElementById("notelist");
            notelistinput.value = notejson ;
            var userid = "110";
            var userinput = document.getElementById("userid");
            userinput.value = userid;
            var melodynameinput = document.getElementById("melodyname");
            var melodydescriptioninput = document.getElementById("melodydescription");
            var scorenameinput = document.getElementById("scorename");
            var scoredescriptioninput = document.getElementById("scoredescription");
             melodynameinput.value = melodynameinput.innerHTML;
             melodydescriptioninput.value = melodydescriptioninput.innerHTML ;
             scorenameinput.value = "ScoreName" ;
             scoredescriptioninput.value = "ScoreDescription";
             o.submit();

        }

        function getMelody(){
            if (str.length == 0) {
                document.getElementById("txtHint").innerHTML = "";
                return;
            } else {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var melodylist = this.responseText ;
                        melodylist = JSON.parse(melodylist);
                        for(var i = 0 ; i<melodylist.length; i++){

                        }
                    }
                };
                xmlhttp.open("POST", "getMelody.php?userid=" + userid, true);
                xmlhttp.send();
            }
        }

        function getScore(){

        }

        window.onload= function(){
            var userid = "110";
            var xmlhttp =  new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){

                    //var userinfo = document.getElementById("userInfo");
                   // alert(userid);
                    //alert(this.responseText);
                   // alert(this.responseText);
                    var receiveText = JSON.parse(this.responseText);

                    var melodylist = receiveText["melodylist"];
                    var scorelist = receiveText["scorelist"];
                    melodylist = JSON.parse(melodylist);//complex array of melody
                    scorelist = JSON.parse(scorelist);//complex array of chord
                    //array of melody 1.length & 2.note name
                    //alert(scorelist);
                    for (var i =0 ;i < melodylist.length ; i++){
                        var melody = melodylist[i];
                        //alert(melody);
                        var melodyobject = JSON.parse(melody);
                        var start = 0 ;
                        var keys = new Array() ;
                        for(var j in melodyobject){
                            keys[start++] = j;
                        }

                        //alert(keys[2]);
                        //alert(melodyobject[keys[2]]);
                        //alert(keys[1]);
                        //alert(melodyobject[keys[1]]);
                        notelist[i] = melodyobject[keys[2]];
                        nlengthlist[i] = melodyobject[keys[1]];
                        name = melodyobject[keys[3]];
                        //alert("melody list: " + notelist);
                        //alert("melody length list: " + nlengthlist);
                        //alert("user score name list: " + name);

                        //display name of scores under this user
                        var newRow = document.getElementById("userTable").insertRow();
                        var newCell = newRow.insertCell();
                        newCell.innerHTML = name + i ;
                        newCell.addEventListener("click",displayBlockfunction);
                        /* for(var s=0 ;s<notelist.length; s++){

                        } */

                        //for (var s = 0 ; s<)
                        // alert(melodyobject.ChordList);
                    }
                    //var melodylist = receiveText["melodylist"];
                    //var melody = melodylist[0];
                    // var melody = JSON.parse(melody);
                    //alert(melody);

                    //array of chord 1.length & 2.note name
                    for (var i =0 ;i < scorelist.length ; i++){
                        var chord = scorelist[i];
                        //alert(chord);
                        var chordobject = JSON.parse(chord);
                        var start = 0 ;
                        var keys = new Array() ;
                        for(var j in chordobject){
                            keys[start++] = j;
                        }

                        chordlist = chordobject[keys[2]];
                        clengthlist = chordobject[keys[3]];
                        //alert(clengthlist);
                        //alert(clengthlist);
                        //alert("chord list: " + chordlist);
                        //alert("chord length list: " + clengthlist);
                        /* for(var s=0 ;s<chordlist.length; s++){


                        } */
                    }

                    //start to put data into table
                    //display username
                    document.getElementById("userName").innerHTML = "Test";
                    
                }
            };
            xmlhttp.open("GET" , "getUserScore.php?userid=" +userid , true );
            xmlhttp.send();
        }

       var displayBlockfunction =  function displayBlock(){
            //firstly clear all fields
            for(i=document.getElementById("melrow1").cells.length-1;i>0;i--){
            document.getElementById("melrow1").deleteCell(i);
            }
            for(i=document.getElementById("melrow2").cells.length-1;i>0;i--){
                document.getElementById("melrow2").deleteCell(i);
            }
            for(i=document.getElementById("melrow3").cells.length-1;i>0;i--){
                document.getElementById("melrow3").deleteCell(i);
            }
            for(i=document.getElementById("melrow4").cells.length-1;i>0;i--){
                document.getElementById("melrow4").deleteCell(i);
            }
            for(i=document.getElementById("chorow1").cells.length-1;i>0;i--){
                document.getElementById("chorow1").deleteCell(i);
            }
            for(i=document.getElementById("chorow2").cells.length-1;i>0;i--){
                document.getElementById("chorow2").deleteCell(i);
            }
            for(i=document.getElementById("chorow3").cells.length-1;i>0;i--){
                document.getElementById("chorow3").deleteCell(i);
            }
            for(i=document.getElementById("chorow4").cells.length-1;i>0;i--){
                document.getElementById("chorow4").deleteCell(i);
            }

            Str = "4d 54 68 64 00 00 00 06 00 02 00 03 00 78 4d 54 72 6b 00 00 00 17 00 ff 03 00 00 ff 51 03 07 a1 20 00 ff 58 04 04 02 18 08 00 ff 2f 00 ";
            melHead = "4d 54 72 6b ";
            choHead = "4d 54 72 6b ";
            melStr = "00 ff 03 00 "; 
            choStr = "00 ff 03 00 ";
            endStr = "00 ff 2f 00 "
            
            //create new
            var blockColorCache;

            var seqnumber  = this.innerHTML.substring(10);
            var nlengthlistlc = nlengthlist[seqnumber];   // nlengthlistlc is a string
            var notelistlc = notelist[seqnumber];
            var clengthlistlc = clengthlist;     // clengthlistlc is a string
            var chordlistlc = chordlist;
            //alert(chordlist);
            //alert(clengthlist);
           /*  //test sentence
            var notelistlc = "['A#4','C4','C#4','E4']";
            var nlengthlistlc = "['4','4','4','4']";
            var chordlistlc = "['C4','C#4','A#4','E4']";
            var clengthlistlc = "['2','3','5','6']"; */
            
            //delete"["&"]"
            nlengthlistlc = nlengthlistlc.slice(1);
            nlengthlistlc = nlengthlistlc.substr(0,nlengthlistlc.length-1);
            notelistlc = notelistlc.slice(1);
            notelistlc = notelistlc.substr(0,notelistlc.length-1);
            clengthlistlc = clengthlistlc.slice(1);
            clengthlistlc = clengthlistlc.substr(0,clengthlistlc.length-1);
            chordlistlc = chordlistlc.slice(1);
            chordlistlc = chordlistlc.substr(0,chordlistlc.length-1);
            var nlengthlistArray = nlengthlistlc.split(",");    // nlengthlistlc become an array
            var notelistArray = notelistlc.split(",");
            var clengthlistArray = clengthlistlc.split(",");    // nlengthlistlc become an array
            var chordlistArray = chordlistlc.split(",");
            var length1 = nlengthlistArray.length;    //length of array
            var length2 = notelistArray.length;
            var length3 = clengthlistArray.length;    //length of array
            var length4 = chordlistArray.length;

            //melody display
            for(var i=0;i<length1;i++){
                //delete'"'&'"'
                notelistArray[i] = notelistArray[i].slice(1);
                notelistArray[i] = notelistArray[i].substr(0,notelistArray[i].length-1);
                nlengthlistArray[i] = nlengthlistArray[i].slice(1);
                nlengthlistArray[i] = nlengthlistArray[i].substr(0,nlengthlistArray[i].length-1);

                var noteNameCache = notelistArray[i];
                var noteLengthCache = nlengthlistArray[i];
                //alert("notenamecache:" + i + ": " + noteNameCache);
                //alert("noteLengthCache:" + i + ": " + noteLengthCache);
                
                switch (noteNameCache.substr(0,1)){
                    case "C":
                        if (noteNameCache.substr(1,1)=="-"||(noteNameCache.substr(1,1)>="0"&&noteNameCache.substr(1,1)<="7")){
                            blockColorCache = "#3eede7";
                        }else if(noteNameCache.substr(1,1)=="#"){
                            blockColorCache = "#4b5cc4";
                        }
                        break;
                    case "D":
                        if (noteNameCache.substr(1,1)=="-"||(noteNameCache.substr(1,1)>="0"&&noteNameCache.substr(1,1)<="7")){
                            blockColorCache = "#8d4bbb";
                        }else if(noteNameCache.substr(1,1)=="#"){
                            blockColorCache = "#ff4777";
                        }
                        break;
                    case "E":
                            blockColorCache = "#ca6924";
                        break;
                    case "F":
                        if (noteNameCache.substr(1,1)=="-"||(noteNameCache.substr(1,1)>="0"&&noteNameCache.substr(1,1)<="7")){
                            blockColorCache = "#eacd76";
                        }else if(noteNameCache.substr(1,1)=="#"){
                            blockColorCache = "#d6c6af";
                        }
                        break;
                    case "G":
                        if (noteNameCache.substr(1,1)=="-"||(noteNameCache.substr(1,1)>="0"&&noteNameCache.substr(1,1)<="7")){
                            blockColorCache = "#3de1ad";
                        }else if(noteNameCache.substr(1,1)=="#"){
                            blockColorCache = "#70f3ff";
                        }
                        break;
                    case "A":
                        if (noteNameCache.substr(1,1)=="-"||(noteNameCache.substr(1,1)>="0"&&noteNameCache.substr(1,1)<="7")){
                            blockColorCache = "#f20c00";
                        }else if(noteNameCache.substr(1,1)=="#"){
                            blockColorCache = "#ffa400";
                        }
                        break;
                    case "B":
                            blockColorCache = "#fff143";
                        break;    
                }

                var td1 = document.getElementById("melrow1").insertCell();
                td1.colSpan = parseInt(noteLengthCache);
                td1.innerHTML = noteLengthCache;

                for (j=0;j<parseInt(noteLengthCache);j++){
                    var td2 = document.getElementById("melrow2").insertCell();
                    td2.setAttribute("width","50px");
                    td2.style.backgroundColor = blockColorCache;
                }

                var td3 = document.getElementById("melrow3").insertCell();
                td3.colSpan = parseInt(noteLengthCache);
                td3.innerHTML = noteNameCache;

               

                var td4 = document.getElementById("melrow4").insertCell();
                td4.colSpan = parseInt(noteLengthCache);
                td4.innerHTML = "<button onclick='deleteNote(this)'>delete</button>"; 
                
                //generate string to be played
                switch (noteNameCache.substr(0,1)){
                    case "C":
                        if (noteNameCache.substr(1,1)=="#"){
                            noteNumber = 1;
                        }else{
                            noteNumber = 0;
                        }
                        break;
                    case "D":
                        if (noteNameCache.substr(1,1)=="#"){
                            noteNumber = 3;
                        }else{
                            noteNumber = 2;
                        }
                        break;
                    case "E":
                        noteNumber = 4;
                        break;
                    case "F":
                        if (noteNameCache.substr(1,1)=="#"){
                            noteNumber = 6;
                        }else{
                            noteNumber = 5;
                        }
                        break;
                    case "G":
                        if (noteNameCache.substr(1,1)=="#"){
                            noteNumber = 8;
                        }else{
                            noteNumber = 7;
                        }
                        break;
                    case "A":
                        if (noteNameCache.substr(1,1)=="#"){
                            noteNumber = 10;
                        }else{
                            noteNumber = 9;
                        }
                        break;
                    case "B":
                        noteNumber = 11;
                        break;
                }
                
                //initial temporary variable
                var nnCache = noteNameCache.substr(1,noteNameCache.length-1);
                if (nnCache.substr(0,1)=="#"){
                    nnCache = nnCache.substr(1,nnCache.length-1);
                }

                switch (nnCache){
                    case "-2":
                        noteNumber += 0;
                        break;
                    case "-1":
                        noteNumber += 12;
                        break;
                    case "0":
                        noteNumber += 24;
                        break;
                    case "1":
                        noteNumber += 36;
                        break;
                    case "2":
                        noteNumber += 48;
                        break;
                    case "3":
                        noteNumber += 60;
                        break;
                    case "4":
                        noteNumber += 72;
                        break;
                    case "5":
                        noteNumber += 84;
                        break;
                    case "6":
                        noteNumber += 96;
                        break;
                    case "7":
                        noteNumber += 108;
                        break;
                }
                //alert(noteNumber);
                //alert(noteNumber.toString(16));
                
                //transform to HEX
                melStr = melStr + "00 90 " + noteNumber.toString(16) + " ";
                
                //add velocity
                melStr = melStr + "64 ";

                //add time length
                noteTime = noteLengthCache * 60;
                //alert(noteTime);
                switch (noteTime){
                    case 60:
                        melStr = melStr + noteTime.toString(16) + " ";
                        break;
                    case 120:
                        melStr = melStr + noteTime.toString(16) + " ";
                        break;
                    case 180:
                        melStr = melStr + "81 34 ";
                        break;
                    case 240:
                        melStr = melStr + "81 70 ";
                        break;
                    case 300:
                        melStr = melStr + "82 2C ";
                        break;
                    case 360:
                        melStr = melStr + "82 68 ";
                        break;
                    case 420:
                        melStr = melStr + "83 24 ";
                        break;
                    case 480:
                        melStr = melStr + "83 60 ";
                        break;   
                }
            
            //release
            melStr = melStr + "80 " + noteNumber.toString(16) + " " + "64 ";
            //alert("melStr: " + melStr);
        
        } 

            //chord display
            for(var i=0;i<length1;i++){
                //delete'"'&'"'
                chordlistArray[i] = chordlistArray[i].slice(1);
                chordlistArray[i] = chordlistArray[i].substr(0,chordlistArray[i].length-1);
                clengthlistArray[i] = clengthlistArray[i].slice(1);
                clengthlistArray[i] = clengthlistArray[i].substr(0,clengthlistArray[i].length-1);
                //alert(chordlistArray);
                var chordNameCache = chordlistArray[i];
                var chordLengthCache = clengthlistArray[i];
                //alert("chordnamecache:" + i + ": " + chordNameCache);
                //alert("chordLengthCache:" + i + ": " + chordLengthCache);
                
                switch (chordNameCache.substr(0,1)){
                    case "C":
                        if (chordNameCache.substr(1,1)=="-"||(chordNameCache.substr(1,1)>="0"&&chordNameCache.substr(1,1)<="7")){
                            blockColorCache = "#3eede7";
                        }else if(chordNameCache.substr(1,1)=="#"){
                            blockColorCache = "#4b5cc4";
                        }
                        break;
                    case "D":
                        if (chordNameCache.substr(1,1)=="-"||(chordNameCache.substr(1,1)>="0"&&chordNameCache.substr(1,1)<="7")){
                            blockColorCache = "#8d4bbb";
                        }else if(chordNameCache.substr(1,1)=="#"){
                            blockColorCache = "#ff4777";
                        }
                        break;
                    case "E":
                            blockColorCache = "#ca6924";
                        break;
                    case "F":
                        if (chordNameCache.substr(1,1)=="-"||(chordNameCache.substr(1,1)>="0"&&chordNameCache.substr(1,1)<="7")){
                            blockColorCache = "#eacd76";
                        }else if(chordNameCache.substr(1,1)=="#"){
                            blockColorCache = "#d6c6af";
                        }
                        break;
                    case "G":
                        if (chordNameCache.substr(1,1)=="-"||(chordNameCache.substr(1,1)>="0"&&chordNameCache.substr(1,1)<="7")){
                            blockColorCache = "#3de1ad";
                        }else if(chordNameCache.substr(1,1)=="#"){
                            blockColorCache = "#70f3ff";
                        }
                        break;
                    case "A":
                        if (chordNameCache.substr(1,1)=="-"||(chordNameCache.substr(1,1)>="0"&&chordNameCache.substr(1,1)<="7")){
                            blockColorCache = "#f20c00";
                        }else if(chordNameCache.substr(1,1)=="#"){
                            blockColorCache = "#ffa400";
                        }
                        break;
                    case "B":
                            blockColorCache = "#fff143";
                        break;    
                }

                var td5 = document.getElementById("chorow1").insertCell();
                td5.colSpan = parseInt(chordLengthCache);
                td5.innerHTML = chordLengthCache;

                for (j=0;j<parseInt(chordLengthCache);j++){
                    var td6 = document.getElementById("chorow2").insertCell();
                    td6.setAttribute("width","50px");
                    td6.style.backgroundColor = blockColorCache;
                }

                var td7 = document.getElementById("chorow3").insertCell();
                td7.colSpan = parseInt(chordLengthCache);
                td7.innerHTML = chordNameCache;

               

                var td8 = document.getElementById("chorow4").insertCell();
                td8.colSpan = parseInt(chordLengthCache);
                td8.innerHTML = "<button onclick='deleteChord(this)'>delete</button>";
                
                //generate string to be played
                switch (chordNameCache.substr(0,1)){
                    case "C":
                        if (chordNameCache.substr(1,1)=="#"){
                            chordNumber = 1;
                        }else{
                            chordNumber = 0;
                        }
                        break;
                    case "D":
                        if (chordNameCache.substr(1,1)=="#"){
                            chordNumber = 3;
                        }else{
                            chordNumber = 2;
                        }
                        break;
                    case "E":
                        chordNumber = 4;
                        break;
                    case "F":
                        if (chordNameCache.substr(1,1)=="#"){
                            chordNumber = 6;
                        }else{
                            chordNumber = 5;
                        }
                        break;
                    case "G":
                        if (chordNameCache.substr(1,1)=="#"){
                            chordNumber = 8;
                        }else{
                            chordNumber = 7;
                        }
                        break;
                    case "A":
                        if (chordNameCache.substr(1,1)=="#"){
                            chordNumber = 10;
                        }else{
                            chordNumber = 9;
                        }
                        break;
                    case "B":
                        chordNumber = 11;
                        break;
                }
                
                var cnCache = chordNameCache.substr(1,chordNameCache.length-1);     //initial temporary variable
                if (cnCache.substr(-1)=="m"){
                    cnCache = cnCache.substr(0,cnCache.length-1);
                    if (cnCache.substr(0,1)=="#"){
                        cnCache = cnCache.substr(1,cnCache.length-1);
                    }
                }else{
                    if (cnCache.substr(0,1)=="#"){
                        cnCache = cnCache.substr(1,cnCache.length-1);
                    }
                }
                switch (cnCache){
                    case "-2":
                        chordNumber += 0;
                        break;
                    case "-1":
                        chordNumber += 12;
                        break;
                    case "0":
                        chordNumber += 24;
                        break;
                    case "1":
                        chordNumber += 36;
                        break;
                    case "2":
                        chordNumber += 48;
                        break;
                    case "3":
                        chordNumber += 60;
                        break;
                    case "4":
                        chordNumber += 72;
                        break;
                    case "5":
                        chordNumber += 84;
                        break;
                    case "6":
                        chordNumber += 96;
                        break;
                    case "7":
                        chordNumber += 108;
                        break;
                }

                //transform to HEX
                if (chordNameCache.substr(-1)!="m"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }else if (chordNameCache.substr(-1)!="m"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber += 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }
                
                //add time
                chordTime = chordLengthCache * 60;
                //alert(chordTime);
                switch (chordTime){
                    case 60:
                        choStr = choStr + chordTime.toString(16) + " ";
                        break;
                    case 120:
                        choStr = choStr + chordTime.toString(16) + " ";
                        break;
                    case 180:
                        choStr = choStr + "81 34 ";
                        break;
                    case 240:
                        choStr = choStr + "81 70 ";
                        break;
                    case 300:
                        choStr = choStr + "82 2C ";
                        break;
                    case 360:
                        choStr = choStr + "82 68 ";
                        break;
                    case 420:
                        choStr = choStr + "83 24 ";
                        break;
                    case 480:
                        choStr = choStr + "83 60 ";
                        break;   
                }

                //release
                if (chordNameCache.substr(-1)!="m"){
                    choStr = choStr + "80 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }else if (chordNameCache.substr(-1)=="m"){
                    choStr = choStr + "00 90 " + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 4;
                    choStr = choStr + chordNumber.toString(16) + " 64 00 ";
                    chordNumber -= 3;
                    choStr = choStr + chordNumber.toString(16) + " 64 ";
                }

                //alert("choStr: " + choStr);
            } 
        }
        
        function test(){
            document.getElementById("test").addEventListener("click",displayBlockfunction);
        }
    </script>


    </body>

</html>