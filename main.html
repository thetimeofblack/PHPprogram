<!DOCTYPE html>
<html lang="en">

<head> 
    <meta charset="UTF-8">
    <title>Score Editor</title>

    <script>
        window.onload= function(){
            var userid = "23";
            var xmlhttp =  new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){

                    //var userinfo = document.getElementById("userInfo");
                   // alert(userid);
                    //alert(this.responseText);
                    
                    var receiveText = JSON.parse(this.responseText);
                    var melodylist = receiveText["melodylist"];
                    var scorelist = receiveText["scorelist"];
                    melodylist = JSON.parse(melodylist);//complex array of melody
                    scorelist = JSON.parse(scorelist);//complex array of chord
                    //array of melody 1.length & 2.note name
                    for (var i =0 ;i < melodylist.length ; i++){
                        var melody = melodylist[i];
                        //alert(melody);
                        var melodyobject = JSON.parse(melody);
                        var start = 0 ;
                        var keys = new Array() ;
                        for(var j in melodyobject){
                            keys[start++] = j;
                        }

                        //alert(keys[2]);
                        //alert(melodyobject[keys[2]]);
                        //alert(keys[1]);
                        //alert(melodyobject[keys[1]]);
                        var notelist = melodyobject[keys[2]];
                        var nlengthlist = melodyobject[keys[1]];
                        var name = melodyobject[keys[3]];
                        alert("melody list: " + notelist);
                        alert("melody length list: " + nlengthlist);
                        alert("user score name list: " + name);

                        //display name of scores under this user
                        var newRow = document.getElementById("userTable").insertRow();
                        var newCell = newRow.insertCell();
                        newCell.innerHTML = name.value;

                        /* for(var s=0 ;s<notelist.length; s++){

                        } */

                        //for (var s = 0 ; s<)
                        // alert(melodyobject.ChordList);
                    }
                    //var melodylist = receiveText["melodylist"];
                    //var melody = melodylist[0];
                    // var melody = JSON.parse(melody);
                    //alert(melody);

                    //array of chord 1.length & 2.note name
                    for (var i =0 ;i < scorelist.length ; i++){
                        var chord = scorelist[i];
                        //alert(chord);
                        var chordobject = JSON.parse(chord);
                        var start = 0 ;
                        var keys = new Array() ;
                        for(var j in chordobject){
                            keys[start++] = j;
                        }

                        //alert(keys[2]);
                        //alert(melodyobject[keys[2]]);
                        //alert(keys[1]);
                        //alert(melodyobject[keys[1]]);
                        var chordlist = chordobject[keys[2]];
                        var clengthlist = chordobject[keys[1]];
                        alert("chord list: " + chordlist);
                        alert("chord length list: " + clengthlist);
                        /* for(var s=0 ;s<chordlist.length; s++){


                        } */
                    }

                    //start to put data into table
                    //display username
                    document.getElementById("userName").innerHTML = userid;
                    
                }
            };
            xmlhttp.open("GET" , "getUserScore.php?userid=" +userid , true );
            xmlhttp.send();
        }
        
        function changeTabNote(){
            if (document.getElementById("melody").style.display == "none"){
                document.getElementById("melody").style.display = "block";
                document.getElementById("chord").style.display = "none";
            }
        }

        function changeTabChord(){    
            if (document.getElementById("chord").style.display == "none"){
                document.getElementById("chord").style.display = "block";
                document.getElementById("melody").style.display = "none";
            }
        }

        function addNote(noteName,blockColor){
            if((document.getElementById("noteLength").value>0)&&(!document.getElementById("noteGroup").value=="")){
                var tr1 = document.getElementById("melrow1");
                var td1 = tr1.insertCell();
                //td1.setAttribute ("className","tick");
                td1.colSpan = document.getElementById("noteLength").value;
                td1.innerHTML = document.getElementById("noteLength").value;
                //alert(tr1.cells.length);
                var tr2 = document.getElementById("melrow2");
                for (i=0;i<document.getElementById("noteLength").value;i++){
                    var td2 = tr2.insertCell();
                    //td2.style.width="200px";
                    //td2.style.minwidth="200px";
                    td2.setAttribute("width","50px");
                    td2.style.backgroundColor = blockColor;
                }
         
                //alert(tr2.cells.length);

                var tr3 = document.getElementById("melrow3");
                var td3 = tr3.insertCell();
                //td3.setAttribute ("className","tick");
                td3.colSpan = document.getElementById("noteLength").value;
                td3.innerHTML = noteName + document.getElementById("noteGroup").value;
        
                var tr4 = document.getElementById("melrow4");
                var td4 = tr4.insertCell();
                //td4.setAttribute ("className","tick");
                td4.colSpan = document.getElementById("noteLength").value;
                //alert(unitCount);
                //alert(td4.parentNode.cells.length - 1);
                td4.innerHTML = "<button onclick='deleteNote(this)'>delete</button>";
                //alert(td4.colomn.count);
                //unitCount += parseInt(document.getElementById("noteLength").value);
            }
        }


        function addChord(chordName,blockColor){
            if((document.getElementById("chordLength").value>0)&&(!document.getElementById("chordGroup").value=="")){
                var tr5 = document.getElementById("chorow1");
                var td5 = tr5.insertCell();
                //td5.setAttribute ("className","tick");
                td5.colSpan = document.getElementById("chordLength").value;
                td5.innerHTML = document.getElementById("chordLength").value;
                
                var tr6 = document.getElementById("chorow2");
                for (i=0;i<document.getElementById("chordLength").value;i++){
                    var td6 = tr6.insertCell();
                    //td6.style.width="200px";
                    //td6.style.minwidth="200px";
                    td6.setAttribute("width","50px");
                    td6.style.backgroundColor = blockColor;
                }
                
                var tr7 = document.getElementById("chorow3");
                var td7 = tr7.insertCell();
                td7.colSpan = document.getElementById("chordLength").value;
                //alert(document.getElementById("color").value);
                if (document.getElementById("color").value == "major"){
                    td7.innerHTML = chordName + document.getElementById("chordGroup").value;
                }else if(document.getElementById("color").value == "minor"){
                    td7.innerHTML = chordName + document.getElementById("chordGroup").value + "m";
                }

                var tr8 = document.getElementById("chorow4");
                var td8 = tr8.insertCell();
                //td8.setAttribute ("className","tick");
                td8.colSpan = document.getElementById("chordLength").value;
                td8.innerHTML = "<button onclick='deleteChord(this)'>delete</button>";
            }
        }

        function deleteNote(o){
            //alert(o.parentNode.cellIndex)
            //alert("name" + o.name);
            //alert("id" + o.id)
            //alert("length"+(o.parentNode.parentNode.cells.length-1));
            //alert("value" + document.getElementById("melodyTable").rows[1].cells[o.id].innerHTML);
            var startCellIndex = 1;
            for(i=1;i<o.parentNode.cellIndex;i++){
                startCellIndex = startCellIndex + parseInt(document.getElementById("melodyTable").rows[1].cells[i].innerHTML); 
            }
            //parseInt(document.getElementById("melrow2").cells.length - document.getElementById("melodyTable").rows[1].cells[o.parentNode.parentNode.cells.length - 1].innerHTML);
            var singleIndex = parseInt(o.parentNode.cellIndex);
            var duration = parseInt(document.getElementById("melodyTable").rows[1].cells[o.parentNode.cellIndex].innerHTML);
            //alert("startCellIndex" + startCellIndex);
            //alert("singleIndex" + singleIndex);
            //alert("duration" + duration);
            
            //delete single cell
            document.getElementById("melrow1").deleteCell(o.parentNode.cellIndex);
            document.getElementById("melrow3").deleteCell(o.parentNode.cellIndex);
            document.getElementById("melrow4").deleteCell(o.parentNode.cellIndex);

            //delete block
            for(i=0;i<duration;i++){
                document.getElementById("melrow2").deleteCell(startCellIndex);
            }
        }

            function deleteChord(o){
            //alert(o.parentNode.cellIndex)
            //alert("name" + o.name);
            //alert("id" + o.id)
            //alert("length"+(o.parentNode.parentNode.cells.length-1));
            //alert("value" + document.getElementById("melodyTable").rows[1].cells[o.id].innerHTML);
            var startCellIndex = 1;
            for(i=1;i<o.parentNode.cellIndex;i++){
                startCellIndex = startCellIndex + parseInt(document.getElementById("chordTable").rows[1].cells[i].innerHTML); 
            }
            var singleIndex = parseInt(o.parentNode.cellIndex);
            var duration = parseInt(document.getElementById("chordTable").rows[1].cells[o.parentNode.cellIndex].innerHTML);
            //alert("startCellIndex" + startCellIndex);
            //alert("singleIndex" + singleIndex);
            //alert("duration" + duration);
            
            //delete single cell
            document.getElementById("chorow1").deleteCell(o.parentNode.cellIndex);
            document.getElementById("chorow3").deleteCell(o.parentNode.cellIndex);
            document.getElementById("chorow4").deleteCell(o.parentNode.cellIndex);

            //delete block
            for(i=0;i<duration;i++){
                document.getElementById("chorow2").deleteCell(startCellIndex);
            }
        }
        function test(){
            alert(this.name);

        }


    </script>


    <style>
        body{
            background-color:rgba(0,128,255,0.2);
        }

        footer{
			color:black;
			font-family:Bahnschrift;
			font-size:20px;
			text-align:center;
			padding-top:150px;
		}

        #hint{
            color:black;
			font-family:Bahnschrift;
			font-size:18px;
        }
    </style>
</head>

<body>
    <!-- login interface -->

    <header>
    </header>


    <!-- title -->
    <h1 style="font-size:50px;font-family:Arial Black;color:orange;text-align:center;">Build your own score!</h1>


    <table border="1" style="table-layout:fixed;width:1880px;" align="center">
        <tr>
            <!-- note choosing pad -->
            <td style="width:400px;background-color:#fffbf0;">
                <!-- choosing window -->
                <div style="text-align:center;">
                    <div align="center">
                        <button style="width:140px;height:70px;font-size:20px;font-family:Arial Black;font-weight:bold;color:black;background-color:white;" onclick="changeTabNote()">Melody</button>
                        <button style="width:140px;height:70px;font-size:20px;font-family:Arial Black;font-weight:bold;color:black;background-color:white;" onclick="changeTabChord()">Chord</button>
                    </div>
                    <br><br>
                    <!-- note pad -->
                    <section id="melody" name="melody" style="text-align:center;display:block;">
                        <table align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr>
                                <td>
                                    <button onclick="addNote('A','#f20c00')">A</button><br>
                                    <button onclick="addNote('A#','#ffa400')">A#</button><br>
                                    <button onclick="addNote('B','#fff143')">B</button><br>
                                    <button onclick="addNote('B#','#00bc12')">B#</button><br>
                                    <button onclick="addNote('C','#3eede7')">C</button><br>
                                    <button onclick="addNote('C#','#4b5cc4')">C#</button><br>
                                    <button onclick="addNote('D','#8d4bbb')">D</button><br>
                                    <button onclick="addNote('D#','#ff4777')">D#</button><br>
                                    <button onclick="addNote('E','#ca6924')">E</button><br>
                                    <button onclick="addNote('F','#eacd76')">F</button><br>
                                    <button onclick="addNote('F#','#d6c6af')">F#</button><br>
                                    <button onclick="addNote('G','#3de1ad')">G</button><br>
                                    <button onclick="addNote('G#','#70f3ff')">G#</button><br>
                                </td>
                                <td>
                                    <p id="hint">please select the note group</p>
                                    <select id="noteGroup" name="noteGroup">
                                        <option value="">---</option>
                                        <option value="-2">-2</option>
                                        <option value="-1">-1</option>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                    </select>
                                    <p id="hint">please select the length</p>
                                    <input type="text" size="1" maxlength="1" id="noteLength" name="noteLength"/>
                                </td>
                            </tr>
                        </table>
                        
                    </section>
					
                    <!-- chord pad -->
                    <section id="chord" name="chord" style="display:none">
                        <table align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr>
                                <td>
                                    <button onclick="addChord('A','#f20c00')">A</button><br>
                                    <button onclick="addChord('A#','#ffa400')">A#</button><br>
                                    <button onclick="addChord('B','#fff143')">B</button><br>
                                    <button onclick="addChord('B#','#00bc12')">B#</button><br>
                                    <button onclick="addChord('C','#3eede7')">C</button><br>
                                    <button onclick="addChord('C#','#4b5cc4')">C#</button><br>
                                    <button onclick="addChord('D','#8d4bbb')">D</button><br>
                                    <button onclick="addChord('D#','#ff4777')">D#</button><br>
                                    <button onclick="addChord('E','#ca6924')">E</button><br>
                                    <button onclick="addChord('F','#eacd76')">F</button><br>
                                    <button onclick="addChord('F#','#d6c6af')">F#</button><br>
                                    <button onclick="addChord('G','#3de1ad')">G</button><br>
                                    <button onclick="addChord('G#','#70f3ff')">G#</button><br>
                                </td>
                                <td>
                                    <p id="hint">Please select the chord color</p>
                                    <select id="color" name="color">
                                        <option value="major">Major</option>
                                        <option value="minor">Minor</option>
                                    </select>
                                    <br><br>
                                    <p id="hint">Please select the chord group</p>
                                    <select id="chordGroup" name="chordGroup">
                                        <option value="">---</option>
                                        <option value="-2">-2</option>
                                        <option value="-1">-1</option>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                    </select>
									<p id="hint">please select the length</p>
                                    <input type="text" size="1" maxlength="1" id="chordLength" name="chordLength"/>
                                </td>
                            </tr>
                        </table>
                        
                    </section>
                </div>
            </td>
            <!-- display window -->
            <td style="width:1070px;background-color:#fffbf0;">
                <span id="hint">Name: </span><input type="text" id="MelodyNameText" />&nbsp;&nbsp;&nbsp;
                <span id="hint">Description: </span><input type="text" id="MelodyDescriptionText"/>
                <br><br>
                <div style="border:solid white 1px;overflow-x:scroll;width:1070px;">
                    <!-- melody display -->
                    <table cellpadding="0" cellspacing="0" id="melodyTable" border="1" table-layout="fixed" style="max-width:1070px;border:solid white 1px;">
                        <th>Melody</th>
                        <tr id="melrow1" height="20px;">
                            <td>Note Length</td>
                        </tr>
                        <tr id="melrow2" height="20px;">
                            <td>Note Block</td>
                        </tr>
                        <tr id="melrow3" height="20px;">
                            <td>Note Name</td>
                        </tr>
                        <tr id="melrow4" height="20px;">
                            <td>&nbsp;&nbsp;&nbsp;</td>
                        </tr>
                    </table>
                </div>
                <br><br>
                <div style="border:solid white 1px;overflow-x:scroll;width:1070px;">
                    <!-- chord display -->
                    <table cellpadding="0" cellspacing="0" id="chordTable" border="1" table-layout="fixed" style="max-width:1070px;border:solid white 1px;">
                        <th>Chord</th>
                        <tr id="chorow1" height="20px;">
                            <td>Chord Length</td>
                        </tr>
                        <tr id="chorow2" height="20px;">
                            <td>Chord Block</td>
                        </tr>
                        <tr id="chorow3" height="20px;">
                            <td>Chord Name</td>
                        </tr>
                        <tr id="chorow4" height="20px;">
                            <td>&nbsp;&nbsp;&nbsp;</td>
                        </tr>
                    </table>
                </div>
                <br><br>
                <div>
                    <button name="play">play</button>
                    <button name="pause">pause</button>
                    <button name="stop">stop</button>
                    <form action="save.php" method="POST" onsubmit="sendData(this);return false;">
                        <input id="scorename" name ="scorename" type="text"  style="display: none;"/>
                        <input id="scoredescription" name ="scoredescription" type="text"  style="display: none;"/>
                        <input id="melodyname" name ="melodyname" type="text"  style="display: none;"/>
                        <input id="melodydescription" name ="melodydescription" type="text"  style="display: none;"/>
                        <input id="lengthlist" name ="lengthlist"  type="text"   style= "display: none;"/>
                        <input id="chordlist"  name ="chordlist"   type="text"   style= "display: none;"/>
                        <input id="timelist"   name ="timelist"    type="text"   style= "display: none;"/>
                        <input id="notelist"   name ="notelist"    type="text"   style= "display: none;"/>
                        <input id="userid"     name = "userid"     type ="text"  style ="display:none;"/>
                        <input name="save"  type="submit" style="margin-left:20%;"/>
                    </form>
                        <input name="getMelody"  type="button"  value="getMelody"    />
                        <input name="getScore"   type="button"  value="getChord"      />
                </div>
            </td>
            <td style="width:400px;background-color:#fffbf0;">
                <div style="text-align:center;">
                    <section  id="userInfo" name="userInfo" style="text-align:center;display:block;">
                        <!-- display user information get from db -->
                        Username: <label id="userName"></label><br><br><br>
                        <table id="userTable" align="center" style="width:300px;border:solid black 2px;text-align:center;">
                            <tr id="userScoreList">
                                <th>Score Name</th>
                            </tr>
                            <!-- use js to add new tr and put DATA into td -->
                        </table>
                    </section>
                </div>
            </td>
        </tr>
    </table>

    <footer>
		<p>CopyrightÂ® 2019 He,Yining Zhou,Kaiwen and Shan,Jiaxiang</p>
	</footer>


    <script>

        function sendData(o) {
            var notelist   =  new Array();
            var lengthlist =  new Array();
            var timelist=   new Array();
            var chordlist=  new Array();



            var melodytdlist1 = document.getElementById("melrow1").childNodes;
            var melodytdlist3 = document.getElementById("melrow3").childNodes;
            var scoretdlist1  = document.getElementById("chorow1").childNodes;
            var scoretdlist3  = document.getElementById("chorow3").childNodes;



            for(i = 3 ; i< melodytdlist3.length ; i++){
                var element = melodytdlist3[i];
                chordlist[i-3] =  element.innerHTML ;
            }


            for(i = 3 ; i< melodytdlist1.length ; i++){
                var element = melodytdlist1[i];
                lengthlist[i-3] = element.innerHTML;
            }


            for(i = 3 ; i< scoretdlist3.length ; i++){
                var element = scoretdlist3[i];
                notelist[i-3] = element.innerHTML;

            }

            for(i=3 ;i<scoretdlist1.length ; i++){
                var element = scoretdlist1[i];
                timelist[i-3] = element.innerHTML;

            }

            var chordjson =  JSON.stringify(chordlist) ;
            var lengthjson = JSON.stringify(lengthlist);
            var notejson =   JSON.stringify(notelist)  ;
            var timejson =   JSON.stringify(timelist)  ;

            var lengthlistinput = document.getElementById("lengthlist");
            lengthlistinput.value = lengthjson ;
            var chordlistinput = document.getElementById("chordlist");
            chordlistinput.value = chordjson ;
            var timelistinput = document.getElementById("timelist");
            timelistinput.value = timejson ;
            var notelistinput = document.getElementById("notelist");
            notelistinput.value = notejson ;
            var userid = "23";
            var userinput = document.getElementById("userid");
            userinput.value = userid;
            var melodynameinput = document.getElementById("melodyname");
            var melodydescriptioninput = document.getElementById("melodydescription");
            var scorenameinput = document.getElementById("scorename");
            var scoredescriptioninput = document.getElementById("scoredescription");
             melodynameinput.value = "MelodyName";
             melodydescriptioninput.value = "MelodyDescription" ;
             scorenameinput.value = "ScoreName" ;
             scoredescriptioninput.value = "ScoreDescription";
             o.submit();

        }

        function getMelody(){
            if (str.length == 0) {
                document.getElementById("txtHint").innerHTML = "";
                return;
            } else {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var melodylist = this.responseText ;
                        melodylist = JSON.parse(melodylist);
                        for(var i = 0 ; i<melodylist.length; i++){

                        }
                    }
                };
                xmlhttp.open("POST", "getMelody.php?userid=" + userid, true);
                xmlhttp.send();
            }
        }

        function getScore(){

        }


        </script>
    </body>
</html>